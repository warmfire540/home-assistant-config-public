#####
# Control master bathroom fan via the switches
#
#####

alias: Master bath fan control
id: d4b5014e-bfd7-4aa7-8735-a66b8902a3f5

trigger:
  - platform: state
    entity_id:
      - switch.master_bath_fan
    from: "off"
    to: "on"
    id: fan-on
    variables:
      switch: switch.master_bath_fan_relay
  - platform: state
    entity_id:
      - switch.master_bath_fan
    from: "on"
    to: "off"
    id: fan-off

  - platform: state
    entity_id:
      - switch.master_bath_shower_light
    from: "off"
    to: "on"
    id: light-on
    variables:
      switch: switch.master_bath_fan_relay_2
  - platform: state
    entity_id:
      - switch.master_bath_shower_light
    from: "on"
    to: "off"
    id: light-off

action:
  choose:
    - conditions:
        condition: trigger
        id:
          - fan-on
          - light-on
      sequence:
        - service: switch.turn_on
          target:
            entity_id: "{{ switch }}"

    - conditions:
        - condition: trigger
          id:
            - fan-off
        - condition: numeric_state
          entity_id: sensor.master_bath_climate_humidity
          below: 65
      sequence:
        - service: switch.turn_off
          target:
            entity_id: switch.master_bath_fan_relay

    - conditions:
        condition: trigger
        id:
          - light-off
      sequence:
        - service: switch.turn_off
          target:
            entity_id: switch.master_bath_fan_relay_2

mode: single
